<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Order Details</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @media print {
            .sidebar, .topbar, .no-print { display: none !important; }
            .main-content { margin: 0; padding: 0; }
            .card { border: none; box-shadow: none; }
        }
        .status-badge { padding: 5px 10px; border-radius: 4px; font-weight: bold; font-size: 14px; }
        .status-Processing { background: #e3f2fd; color: #1976d2; }
        .status-Cutting { background: #fff3e0; color: #e65100; }
        .status-Sewing { background: #f3e5f5; color: #7b1fa2; }
        .status-Ready { background: #e8f5e9; color: #2e7d32; }
        .status-Delivered { background: #263238; color: #fff; }

        .finance-grid {
            display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;
            background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;
        }
        .finance-item label { display: block; font-size: 12px; color: #888; margin-bottom: 5px; }
        .finance-item div { font-size: 20px; font-weight: bold; }
        .bal-red { color: #dc3545; }
        .bal-green { color: #28a745; }

        .item-thumb {
            width: 60px; height: 60px; object-fit: cover; border-radius: 4px; border: 1px solid #ddd;
            cursor: zoom-in; transition: transform 0.2s;
        }
        .item-thumb:hover { transform: scale(1.1); }

        /* IMAGE VIEWER MODAL (LIGHTBOX) */
        #imageViewer {
            display: none; position: fixed; z-index: 2000; left: 0; top: 0;
            width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.9);
            align-items: center; justify-content: center;
        }
        .full-image {
            margin: auto; display: block; max-width: 90%; max-height: 90%;
            border-radius: 5px; box-shadow: 0 0 20px rgba(255,255,255,0.2);
            animation: zoom 0.3s;
        }
        @keyframes zoom { from {transform:scale(0)} to {transform:scale(1)} }
        .close-viewer {
            position: absolute; top: 15px; right: 35px; color: #f1f1f1;
            font-size: 40px; font-weight: bold; cursor: pointer;
        }
    </style>
</head>
<body>

<nav class="sidebar">
    <div class="brand">HandySeam</div>
    <div class="sidebar-menu">
        <a href="/dashboard" class="menu-item">Dashboard</a>
        <a href="/orders/create" class="menu-item">Create New Order</a>
        <a href="/orders" class="menu-item active">View Orders</a>
        <a href="/customers" class="menu-item">Customers</a>
    </div>
</nav>

<header class="topbar"><div class="page-title">Order Details</div></header>

<main class="main-content">
    <div class="card">
        <div style="display: flex; justify-content: flex-end; gap: 10px; margin-bottom: 20px;" class="no-print">
            <a th:href="@{/orders/print/measurements/{id}(id=${order.id})}" target="_blank" class="btn-primary" style="background-color: #17a2b8;">
                <i class="fas fa-ruler"></i> PRINT MEASUREMENTS
            </a>
            <button class="btn-primary" onclick="window.print()"><i class="fas fa-print"></i> RECEIPT</button>
            <a th:href="@{/orders/delete/{id}(id=${order.id})}" onclick="return confirm('Delete this order?')" class="btn-primary" style="background-color: #dc3545;">
                <i class="fas fa-trash"></i> DELETE
            </a>
            <a href="/orders" class="btn-secondary">BACK</a>
        </div>

        <div style="border-bottom: 2px solid #eee; padding-bottom: 20px; margin-bottom: 20px;">
            <h2 th:text="${order.customer.name}" style="color: #2c2440;"></h2>
            <p>Tracking ID: <strong th:text="${order.trackingId}"></strong></p>
        </div>

        <div style="display: flex; gap: 20px; margin-bottom: 30px;">
            <div style="flex: 1;">
                <label style="color: #888; font-size: 12px;">CURRENT STATUS</label>
                <div style="margin-bottom: 10px;">
                    <span th:class="'status-badge status-' + ${order.status}" th:text="${order.status}"></span>
                </div>
                <form action="/orders/updateStatus" method="POST" class="no-print" style="display: flex; gap: 10px;">
                    <input type="hidden" name="orderId" th:value="${order.id}">
                    <select name="status" style="padding: 8px; border-radius: 4px; border: 1px solid #ddd;">
                        <option value="Processing">Processing</option>
                        <option value="Cutting">Cutting</option>
                        <option value="Sewing">Sewing</option>
                        <option value="Ready">Ready</option>
                        <option value="Delivered">Delivered</option>
                    </select>
                    <button type="submit" class="btn-primary" style="padding: 8px 15px;">UPDATE</button>
                </form>
            </div>

            <div style="flex: 1.5;">
                <div class="finance-grid">
                    <div class="finance-item"><label>Total Amount</label><div th:text="${'₹' + order.totalAmount}"></div></div>
                    <div class="finance-item"><label>Paid</label><div style="color: #28a745;" th:text="${'₹' + order.getPaidAmount()}"></div></div>
                    <div class="finance-item"><label>Balance</label><div th:class="${order.getBalanceAmount() > 0} ? 'bal-red' : 'bal-green'" th:text="${'₹' + order.getBalanceAmount()}"></div></div>
                </div>
            </div>
        </div>

        <h4 style="border-bottom: 1px solid #eee; padding-bottom: 10px;">Order Items</h4>
        <table class="data-table" style="margin-bottom: 30px;">
            <thead>
            <tr><th>Image</th><th>Style</th><th>Instruction</th><th>Price</th></tr>
            </thead>
            <tbody>
            <tr th:each="item : ${order.items}">
                <td>
                    <img th:if="${item.hasImage()}"
                         th:src="@{'/orders/image/' + ${item.id}}"
                         class="item-thumb"
                         onclick="openViewer(this.src)">
                    <div th:if="${!item.hasImage()}" style="width: 60px; height: 60px; background: #eee; display: flex; align-items: center; justify-content: center; color: #ccc;">
                        <i class="fas fa-camera"></i>
                    </div>
                </td>
                <td th:text="${item.styleName}"></td>
                <td th:text="${item.instruction}"></td>
                <td th:text="${'₹' + item.price}"></td>
            </tr>
            </tbody>
        </table>

        <div style="background: #f9f9f9; padding: 20px; border-radius: 8px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h4 style="margin: 0;">Payment History</h4>
                <button class="btn-primary no-print" onclick="openPaymentModal()" style="background-color: #28a745;">
                    <i class="fas fa-plus"></i> ADD PAYMENT
                </button>
            </div>
            <table class="data-table" style="background: white;">
                <thead><tr><th>Date</th><th>Mode</th><th>Amount</th></tr></thead>
                <tbody>
                <tr th:each="pay : ${order.payments}">
                    <td th:text="${#temporals.format(pay.paymentDate, 'dd-MM-yyyy HH:mm')}"></td>
                    <td th:text="${pay.paymentMode}"></td>
                    <td th:text="${'₹' + pay.amount}" style="font-weight: bold; color: #28a745;"></td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>
</main>

<div id="imageViewer">
    <span class="close-viewer" onclick="closeViewer()">&times;</span>
    <img class="full-image" id="expandedImg">
</div>

<div id="paymentModal" class="modal">
    <div class="modal-content" style="width: 400px;">
        <div class="modal-header"><h3>Add Payment</h3><span class="close-btn" onclick="closePaymentModal()">&times;</span></div>
        <div class="modal-body">
            <form action="/orders/addPayment" method="POST">
                <input type="hidden" name="orderId" th:value="${order.id}">
                <div class="form-group"><label>Amount (₹)</label><input type="number" step="0.01" name="amount" required></div>
                <div class="form-group"><label>Payment Mode</label>
                    <select name="paymentMode" style="width: 100%; padding: 10px;"><option value="Cash">Cash</option><option value="Online Pay">Online Pay</option><option value="UPI">UPI</option></select>
                </div>
                <div style="text-align: right;"><button type="submit" class="btn-primary" style="background-color: #28a745;">SAVE PAYMENT</button></div>
            </form>
        </div>
    </div>
</div>

<script>
    var payModal = document.getElementById("paymentModal");
    var viewer = document.getElementById("imageViewer");
    var expandedImg = document.getElementById("expandedImg");

    function openPaymentModal() { payModal.style.display = "block"; }
    function closePaymentModal() { payModal.style.display = "none"; }

    // --- IMAGE VIEWER LOGIC ---
    function openViewer(src) {
        viewer.style.display = "flex";
        expandedImg.src = src;
    }
    function closeViewer() {
        viewer.style.display = "none";
    }

   window.onclick = function(event) {
            if (event.target == payModal) payModal.style.display = "none";
            if (event.target == viewer) closeViewer(); // Click outside image to close
        }
</script>
</body>
</html>