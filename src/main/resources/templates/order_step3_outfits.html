<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Add Outfits</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        #camera-container { display: none; background: #000; padding: 10px; border-radius: 8px; margin-bottom: 15px; text-align: center; }
        video { width: 100%; max-width: 400px; border-radius: 4px; }
        canvas { display: none; }
        #preview-container { display: none; text-align: center; margin-bottom: 15px; }
        #snapshot-preview { width: 100%; max-width: 200px; border-radius: 4px; border: 2px solid #2c2440; }

        /* MODE BADGES */
        .mode-badge-ai { background: linear-gradient(45deg, #6200ea, #b388ff); color: white; padding: 3px 8px; border-radius: 10px; font-size: 10px; margin-left: 5px; }
        .mode-badge-norm { background: #666; color: white; padding: 3px 8px; border-radius: 10px; font-size: 10px; margin-left: 5px; }
    </style>
</head>
<body>

<nav class="sidebar">
    <div class="brand">HandySeam</div>
    <div class="sidebar-menu">
        <a href="/dashboard" class="menu-item">Dashboard</a>
        <a href="/orders/create" class="menu-item active">Create New Order</a>
        <a href="/orders" class="menu-item">View Orders</a>
        <a href="/customers" class="menu-item">Customers</a>
    </div>
</nav>

<main class="main-content">
    <div class="card">
        <div class="card-header" style="background-color: #2c2440; color: white; padding: 15px; margin: -25px -25px 20px -25px;">
            <h3>Add Outfits</h3>
        </div>

        <div th:if="${not #lists.isEmpty(currentOrder.items)}" style="background:#f9f9f9; padding:15px; margin-bottom:20px; border-left:4px solid #2c2440;">
            <h4>Items in this order:</h4>
            <div th:each="item : ${currentOrder.items}" style="display:flex; justify-content:space-between; align-items: center; border-bottom:1px solid #ddd; padding:10px 0;">
                <div style="display: flex; align-items: center; gap: 10px;">
                    <img th:if="${item.hasImage()}" th:src="@{'/orders/image/' + ${item.itemId}}" style="width: 50px; height: 50px; object-fit: cover; border-radius: 4px;">
                    <div th:if="${!item.hasImage()}" style="width: 50px; height: 50px; background:#eee;"></div>

                    <div>
                        <div style="font-weight: bold;">
                            <span th:text="${item.styleName}"></span>
                        </div>
                        <div th:text="${item.instruction}" style="font-size: 12px; color: #777;"></div>
                    </div>
                </div>
                <span th:text="${'â‚¹' + item.price}"></span>
            </div>
        </div>

        <form th:action="@{/orders/addOutfit}" th:object="${newItem}" method="POST" style="border:1px solid #ddd; padding:20px; border-radius:5px;">

            <div class="form-group">
                <label>Select Style</label>
                <select name="styleSelect" id="styleSelect" onchange="toggleOtherInput()" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                    <option value="Shirt">Shirt</option>
                    <option value="Pant">Pant</option>
                    <option value="Alteration">Alteration</option>
                    <option value="Lining Blouse">Lining Blouse</option>
                    <option value="Blouse">Blouse</option>
                    <option value="Others">Others (Specify)</option>
                </select>
            </div>

            <div class="form-group" id="otherStyleGroup" style="display: none;">
                <input type="text" name="otherStyle" placeholder="Please specify style name..." style="border-left: 3px solid #ffc107;">
            </div>

            <div class="form-group"><input type="number" step="0.01" th:field="*{price}" placeholder="Price charged" required></div>
            <div class="form-group"><input type="number" th:field="*{quantity}" placeholder="Quantity" value="1"></div>
            <div class="form-group"><textarea th:field="*{instruction}" placeholder="Instruction (optional)"></textarea></div>

            <div class="form-group" style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                <label>Reference Photo</label>

                <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                    <button type="button" class="btn-secondary" onclick="startCamera('normal')" style="flex: 1;">
                        <i class="fas fa-camera"></i> Normal Photo
                    </button>
                    <button type="button" class="btn-primary" onclick="startCamera('ai')" style="flex: 1; background: linear-gradient(45deg, #6200ea, #b388ff);">
                        <i class="fas fa-magic"></i> AI Try-On
                    </button>
                </div>

                <div id="camera-container">
                    <div id="ai-hint" style="color: #b388ff; font-weight: bold; margin-bottom: 5px; display: none;">AI MODE ON: Hold fabric to map to shirt</div>
                    <video id="video" autoplay playsinline></video>
                    <br>
                    <button type="button" class="btn-primary" onclick="takeSnapshot()">SNAP PICTURE</button>
                </div>

                <div id="preview-container">
                    <img id="snapshot-preview">
                    <p id="preview-text" style="font-size: 12px; color: #666;"></p>
                    <button type="button" onclick="retake()" style="background:#dc3545; color: white; border:none; padding: 5px 10px; border-radius: 4px;">Retake</button>
                </div>

                <input type="hidden" id="cameraImage" name="cameraImage">
                <input type="hidden" id="aiMode" name="aiMode" value="false"> <canvas id="canvas"></canvas>
            </div>

            <button type="submit" class="btn-primary" style="background-color: #28a745; width: 100%;">ADD THIS OUTFIT</button>
        </form>

        <div style="margin-top: 30px; text-align: right;"><a th:href="@{/orders/create/invoice}" class="btn-secondary">CONTINUE</a></div>
    </div>
</main>

<script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const preview = document.getElementById('snapshot-preview');
    const cameraContainer = document.getElementById('camera-container');
    const previewContainer = document.getElementById('preview-container');
    const hiddenInput = document.getElementById('cameraImage');
    const aiInput = document.getElementById('aiMode');
    const aiHint = document.getElementById('ai-hint');
    const previewText = document.getElementById('preview-text');

    // Dropdown Logic
    function toggleOtherInput() {
        const val = document.getElementById('styleSelect').value;
        const otherGroup = document.getElementById('otherStyleGroup');
        otherGroup.style.display = (val === 'Others') ? 'block' : 'none';
    }

    // Camera Logic
    function startCamera(mode) {
        cameraContainer.style.display = 'block';
        previewContainer.style.display = 'none';

        // Set AI Mode
        if (mode === 'ai') {
            aiInput.value = "true";
            aiHint.style.display = "block";
        } else {
            aiInput.value = "false";
            aiHint.style.display = "none";
        }

        navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
            .then(stream => { video.srcObject = stream; })
            .catch(err => { alert("Error accessing camera: " + err); });
    }

    function takeSnapshot() {
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        canvas.getContext('2d').drawImage(video, 0, 0);
        const dataURL = canvas.toDataURL('image/png');

        preview.src = dataURL;
        previewContainer.style.display = 'block';
        hiddenInput.value = dataURL;

        if(aiInput.value === "true") {
            previewText.innerText = "Photo ready for AI Processing...";
            previewText.style.color = "#6200ea";
        } else {
            previewText.innerText = "Photo Captured.";
            previewText.style.color = "#666";
        }

        video.srcObject.getTracks().forEach(track => track.stop());
        cameraContainer.style.display = 'none';
    }

    function retake() {
        hiddenInput.value = "";
        preview.src = "";
        previewContainer.style.display = 'none';
        cameraContainer.style.display = 'none';
    }
</script>
</body>
</html>